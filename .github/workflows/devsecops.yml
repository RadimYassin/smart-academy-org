name: DevSecOps CI/CD Pipeline

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

permissions:
  contents: read
  security-events: write  # Required for Trivy SARIF upload
  actions: read  # Required for CodeQL telemetry

env:
  JAVA_VERSION: '17'
  JAVA_DISTRIBUTION: 'temurin'
  MAVEN_OPTS: '-Xmx3072m'

jobs:
  # ==========================================
  # Stage 1: Build & Test
  # ==========================================
  build-and-test:
    name: Build & Test Microservices
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    steps:
      - name: Checkout source code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for SonarCloud
      
      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: ${{ env.JAVA_DISTRIBUTION }}
          cache: 'maven'
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: servers/lmsconnector/package-lock.json

      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'
          cache-dependency-path: servers/Chatbot-edu/requirements*.txt

      - name: Build & Test AI-Services-API
        run: |
          cd servers/AI-Services-API
          pip install -r requirements.txt
          pip install -r requirements-test.txt
          python -m pytest --cov=app --cov=../../src --cov-report=xml:coverage.xml --junitxml=test-results.xml

      - name: Build & Test LMSConnector
        run: |
          cd servers/lmsconnector
          npm ci
          npm run build
          npm run test:cov
      
      - name: Build & Test Chatbot-edu
        run: |
          cd servers/Chatbot-edu
          pip install -r requirements.txt
          pip install -r requirements-test.txt
          python -m pytest --cov=app --cov=services --cov=routers --cov=core --cov-report=xml:coverage.xml --junitxml=test-results.xml
      
      - name: Build User Management Service
        run: |
          cd servers/User-Management
          mvn clean verify -B
      
      - name: Generate Coverage Report - User Management
        run: |
          cd servers/User-Management
          mvn jacoco:report
      
      - name: Build Course Management Service
        run: |
          cd servers/Cour-Management
          mvn clean verify -B
      
      - name: Generate Coverage Report - Course Management
        run: |
          cd servers/Cour-Management
          mvn jacoco:report
      
      - name: Build Gateway Service
        run: |
          cd servers/GateWay
          mvn clean package -DskipTests -B
      
      - name: Build Eureka Server
        run: |
          cd servers/Eureka-Server
          mvn clean package -DskipTests -B
      
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: |
            servers/*/target/*.jar
            servers/lmsconnector/dist/
          retention-days: 7
      
      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results
          path: |
            servers/User-Management/target/surefire-reports/
            servers/Cour-Management/target/surefire-reports/
            servers/Cour-Management/target/surefire-reports/
            servers/lmsconnector/test-results/
            servers/lmsconnector/test-results/
            servers/Chatbot-edu/test-results.xml
            servers/AI-Services-API/test-results.xml
          retention-days: 30
      
      - name: Upload coverage reports
        uses: actions/upload-artifact@v4
        with:
          name: coverage-reports
          path: |
            servers/User-Management/target/site/jacoco/
            servers/Cour-Management/target/site/jacoco/
            servers/Cour-Management/target/site/jacoco/
            servers/lmsconnector/coverage/
            servers/lmsconnector/coverage/
            servers/Chatbot-edu/coverage.xml
            servers/AI-Services-API/coverage.xml
          retention-days: 30
      
      - name: Display Test Summary
        if: always()
        run: |
          echo "## üìä Test Execution Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### LMSConnector Service" >> $GITHUB_STEP_SUMMARY
          if [ -f servers/lmsconnector/coverage/lcov.info ]; then
            echo "‚úÖ Tests executed and coverage generated" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### User Management Service" >> $GITHUB_STEP_SUMMARY
          if [ -f servers/User-Management/target/surefire-reports/*.xml ]; then
            echo "‚úÖ Tests executed" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Course Management Service" >> $GITHUB_STEP_SUMMARY
          if [ -f servers/Cour-Management/target/surefire-reports/*.xml ]; then
            echo "‚úÖ Tests executed - 115 tests" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Chatbot-EDU Service" >> $GITHUB_STEP_SUMMARY
          if [ -f servers/Chatbot-edu/test-results.xml ]; then
            echo "‚úÖ Tests executed" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### AI-Services-API" >> $GITHUB_STEP_SUMMARY
          if [ -f servers/AI-Services-API/test-results.xml ]; then
            echo "‚úÖ Tests executed" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "üìà Coverage reports available in artifacts" >> $GITHUB_STEP_SUMMARY


  # ==========================================
  # Stage 2: SAST - SonarCloud Analysis
  # ==========================================
  sonarcloud:
    name: SonarCloud SAST Analysis
    runs-on: ubuntu-latest
    needs: build-and-test
    permissions:
      contents: read
    
    steps:
      - name: Checkout source code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Required for SonarCloud
      
      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: ${{ env.JAVA_DISTRIBUTION }}
          cache: 'maven'
      
      - name: Cache SonarCloud packages
        uses: actions/cache@v4
        with:
          path: ~/.sonar/cache
          key: ${{ runner.os }}-sonar
          restore-keys: ${{ runner.os }}-sonar

      - name: Download coverage reports
        uses: actions/download-artifact@v4
        with:
          name: coverage-reports
      
      - name: Prepare Chatbot-EDU coverage
        run: |
          mkdir -p servers/Chatbot-edu
          if [ -f servers/Chatbot-edu/coverage.xml ]; then
            echo "‚úÖ Coverage file already in correct location"
          else
            echo "üìã Copying coverage file to correct location"
            cp -v coverage.xml servers/Chatbot-edu/ || echo "‚ö†Ô∏è coverage.xml not found"
          fi
          ls -la servers/Chatbot-edu/

      - name: SonarCloud Scan - User Management
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          cd servers/User-Management
          mvn -B verify sonar:sonar \
            -Dsonar.projectKey=smart-academy-user-management \
            -Dsonar.projectName="User-Management" \
            -Dsonar.organization=smart-academy-org \
            -Dsonar.host.url=https://sonarcloud.io \
            -Dsonar.qualitygate.wait=false
      
      - name: SonarCloud Scan - Course Management
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          cd servers/Cour-Management
          mvn -B verify sonar:sonar \
            -Dsonar.projectKey=smart-academy-course-management \
            -Dsonar.projectName="Course-Management" \
            -Dsonar.organization=smart-academy-org \
            -Dsonar.host.url=https://sonarcloud.io \
            -Dsonar.qualitygate.wait=false

      - name: SonarCloud Scan - LMSConnector
        uses: SonarSource/sonarcloud-github-action@master
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          projectBaseDir: servers/lmsconnector
          args: >
            -Dsonar.organization=smart-academy-org
            -Dsonar.projectKey=smart-academy-lmsconnector
            -Dsonar.projectName="LMSConnector"
            -Dsonar.sources=src
            -Dsonar.tests=src
            -Dsonar.test.inclusions=**/*.spec.ts
            -Dsonar.exclusions=**/*.spec.ts,node_modules/**,dist/**
            -Dsonar.javascript.lcov.reportPaths=coverage/lcov.info

      - name: Debug Chatbot-EDU Coverage
        run: |
          echo "üîç Searching for coverage.xml..."
          find . -name coverage.xml
          echo "üìÇ Listing servers/Chatbot-edu:"
          ls -la servers/Chatbot-edu/
          if [ -f servers/Chatbot-edu/coverage.xml ]; then
            echo "‚úÖ coverage.xml found at expected location"
            head -n 5 servers/Chatbot-edu/coverage.xml
          else
            echo "‚ùå coverage.xml MISSING from expected location"
          fi

      - name: SonarCloud Scan - Chatbot-EDU
        uses: SonarSource/sonarcloud-github-action@master
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          projectBaseDir: servers/Chatbot-edu
          args: >
            -Dsonar.organization=smart-academy-org
            -Dsonar.projectKey=smart-academy-chatbot-edu
            -Dsonar.projectName="Chatbot-EDU"
            -Dsonar.sources=app,services,routers,auth,core
            -Dsonar.tests=tests
            -Dsonar.test.inclusions=tests/**/*.py
            -Dsonar.exclusions=**/__pycache__/**,**/*.pyc,venv/**,.venv/**
            -Dsonar.python.coverage.reportPaths=coverage.xml

      - name: SonarCloud Scan - AI-Services-API
        uses: SonarSource/sonarcloud-github-action@master
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          projectBaseDir: servers/AI-Services-API
          args: >
            -Dsonar.organization=smart-academy-org
            -Dsonar.projectKey=smart-academy-ai-services-api
            -Dsonar.projectName="AI-Services-API"
            -Dsonar.python.coverage.reportPaths=coverage.xml


  # ==========================================
  # Stage 3: SCA -   OWASP Dependency Check
  # ==========================================
  dependency-check:
    name: OWASP Dependency Check (SCA)
    runs-on: ubuntu-latest
    needs: build-and-test
    permissions:
      contents: read
    
    steps:
      - name: Checkout source code
        uses: actions/checkout@v4
      
      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: ${{ env.JAVA_DISTRIBUTION }}
          cache: 'maven'
      
      - name: OWASP Dependency Check - User Management
        uses: dependency-check/Dependency-Check_Action@main
        with:
          project: 'smart-academy-user-management'
          path: './servers/User-Management'
          format: 'HTML,JSON'
          args: >
            --enableRetired
            --enableExperimental
            --failOnCVSS 7
            --suppression ./servers/User-Management/dependency-check-suppressions.xml
        continue-on-error: true
      
      - name: OWASP Dependency Check - Course Management
        uses: dependency-check/Dependency-Check_Action@main
        with:
          project: 'smart-academy-course-management'
          path: './servers/Cour-Management'
          format: 'HTML,JSON'
          args: >
            --enableRetired
            --enableExperimental
            --failOnCVSS 7
        continue-on-error: true
      
      - name: Upload Dependency Check Reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: dependency-check-reports
          path: |
            servers/User-Management/target/dependency-check-report.*
            servers/Cour-Management/target/dependency-check-report.*
          retention-days: 30

  # ==========================================
  # Stage 4: Build Docker Images
  # ==========================================
  build-docker-images:
    name: Build Docker Images
    runs-on: ubuntu-latest
    needs: [build-and-test, sonarcloud]
    permissions:
      contents: read
    
    strategy:
      fail-fast: false  # Continue with other services even if one fails
      matrix:
        service:
          - name: user-management
            context: ./servers/User-Management
            image: smart-academy-user-management
          - name: course-management
            context: ./servers/Cour-Management
            image: smart-academy-course-management
          - name: gateway
            context: ./servers/GateWay
            image: smart-academy-gateway
          - name: eureka-server
            context: ./servers/Eureka-Server
            image: smart-academy-eureka-server
          - name: lmsconnector
            context: ./servers/lmsconnector
            image: smart-academy-lmsconnector
          - name: chatbot-edu
            context: ./servers/Chatbot-edu
            image: smart-academy-chatbot-edu
          - name: ai-services-api
            context: ./servers/AI-Services-API
            image: smart-academy-ai-services-api
    
    steps:
      - name: Checkout source code
        uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Build Docker Image - ${{ matrix.service.name }}
        uses: docker/build-push-action@v5
        with:
          context: ${{ matrix.service.context }}
          push: false
          tags: |
            ${{ secrets.DOCKERHUB_USERNAME }}/${{ matrix.service.image }}:latest
            ${{ secrets.DOCKERHUB_USERNAME }}/${{ matrix.service.image }}:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          load: true
      
      - name: Save Docker Image as Artifact
        run: |
          docker save ${{ secrets.DOCKERHUB_USERNAME }}/${{ matrix.service.image }}:latest \
            -o ${{ matrix.service.name }}.tar
      
      - name: Upload Docker Image Artifact
        uses: actions/upload-artifact@v4
        with:
          name: docker-image-${{ matrix.service.name }}
          path: ${{ matrix.service.name }}.tar
          retention-days: 1

  # ==========================================
  # Stage 5: Container Security - Trivy Scan
  # ==========================================
  trivy-scan:
    name: Trivy Container Security Scan
    runs-on: ubuntu-latest
    needs: build-docker-images
    permissions:
      contents: read
      security-events: write
      actions: read  # Required for CodeQL telemetry
    
    strategy:
      fail-fast: false  # Continue with other services even if one fails
      matrix:
        service:
          - name: user-management
            image: smart-academy-user-management
          - name: course-management
            image: smart-academy-course-management
          - name: gateway
            image: smart-academy-gateway
          - name: eureka-server
            image: smart-academy-eureka-server
          - name: lmsconnector
            image: smart-academy-lmsconnector
          - name: chatbot-edu
            image: smart-academy-chatbot-edu
    
    steps:
      - name: Checkout source code
        uses: actions/checkout@v4
      
      - name: Download Docker Image
        uses: actions/download-artifact@v4
        with:
          name: docker-image-${{ matrix.service.name }}
      
      - name: Load Docker Image
        run: docker load -i ${{ matrix.service.name }}.tar
      
      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ secrets.DOCKERHUB_USERNAME }}/${{ matrix.service.image }}:latest
          format: 'sarif'
          output: 'trivy-results-${{ matrix.service.name }}.sarif'
          severity: 'CRITICAL,HIGH'
          exit-code: '0'  # Report but don't fail pipeline
      
      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v4
        continue-on-error: true  # Optional: Won't fail if Code Scanning is not enabled
        if: always()
        with:
          sarif_file: 'trivy-results-${{ matrix.service.name }}.sarif'
      
      - name: Generate Trivy HTML Report
        uses: aquasecurity/trivy-action@master
        if: always()
        with:
          image-ref: ${{ secrets.DOCKERHUB_USERNAME }}/${{ matrix.service.image }}:latest
          format: 'table'
          output: 'trivy-report-${{ matrix.service.name }}.txt'
          severity: 'CRITICAL,HIGH,MEDIUM,LOW'
      
      - name: Upload Trivy Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: trivy-report-${{ matrix.service.name }}
          path: trivy-report-${{ matrix.service.name }}.txt
          retention-days: 30

  # ==========================================
  # Stage 6: Publish to Docker Hub
  # ==========================================
  publish-to-dockerhub:
    name: Publish Images to Docker Hub
    runs-on: ubuntu-latest
    needs: trivy-scan
    permissions:
      contents: read
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    
    strategy:
      fail-fast: false  # Continue with other services even if one fails
      matrix:
        service:
          - name: user-management
            image: smart-academy-user-management
          - name: course-management
            image: smart-academy-course-management
          - name: gateway
            image: smart-academy-gateway
          - name: eureka-server
            image: smart-academy-eureka-server
          - name: lmsconnector
            image: smart-academy-lmsconnector
          - name: chatbot-edu
            image: smart-academy-chatbot-edu
    
    steps:
      - name: Checkout source code
        uses: actions/checkout@v4
      
      - name: Download Docker Image
        uses: actions/download-artifact@v4
        with:
          name: docker-image-${{ matrix.service.name }}
      
      - name: Load Docker Image
        run: docker load -i ${{ matrix.service.name }}.tar
      
      - name: Tag image with commit SHA
        run: |
          docker tag \
            ${{ secrets.DOCKERHUB_USERNAME }}/${{ matrix.service.image }}:latest \
            ${{ secrets.DOCKERHUB_USERNAME }}/${{ matrix.service.image }}:${{ github.sha }}
      
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      
      - name: Push to Docker Hub - Latest
        run: docker push ${{ secrets.DOCKERHUB_USERNAME }}/${{ matrix.service.image }}:latest
      
      - name: Push to Docker Hub - Commit SHA
        run: docker push ${{ secrets.DOCKERHUB_USERNAME }}/${{ matrix.service.image }}:${{ github.sha }}
      
      - name: Logout from Docker Hub
        if: always()
        run: docker logout

  # ==========================================
  # Pipeline Summary
  # ==========================================
  pipeline-summary:
    name: Pipeline Summary
    runs-on: ubuntu-latest
    needs: [build-and-test, sonarcloud, dependency-check, trivy-scan, publish-to-dockerhub]
    if: always()
    
    steps:
      - name: Pipeline Status Summary
        run: |
          echo "## üîê DevSecOps Pipeline Summary"
          echo ""
          echo "‚úÖ Build & Test: ${{ needs.build-and-test.result }}"
          echo "‚úÖ SonarCloud SAST: ${{ needs.sonarcloud.result }}"
          echo "‚úÖ OWASP Dependency Check: ${{ needs.dependency-check.result }}"
          echo "‚úÖ Trivy Container Scan: ${{ needs.trivy-scan.result }}"
          echo "‚úÖ Docker Hub Publish: ${{ needs.publish-to-dockerhub.result }}"
          echo ""
          echo "Workflow: ${{ github.workflow }}"
          echo "Run Number: ${{ github.run_number }}"
          echo "Commit SHA: ${{ github.sha }}"
