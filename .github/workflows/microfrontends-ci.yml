name: Microfrontends CI/CD

on:
  push:
    branches: [ main, master ]
    paths:
      - 'clients/microfrontends/**'
      - '.github/workflows/microfrontends-ci.yml'
  pull_request:
    branches: [ main, master ]
    paths:
      - 'clients/microfrontends/**'
      - '.github/workflows/microfrontends-ci.yml'
  workflow_dispatch:

permissions:
  contents: read
  security-events: write
  actions: read

env:
  NODE_VERSION: '18'

jobs:
  # ==========================================
  # Stage 1: Build & Test All Microfrontends
  # ==========================================
  build-and-test:
    name: Build & Test ${{ matrix.service.name }}
    runs-on: ubuntu-latest
    
    strategy:
      fail-fast: false
      matrix:
        service:
          - name: shell
            path: clients/microfrontends/shell
            port: 5001
          - name: auth
            path: clients/microfrontends/auth
            port: 5002
          - name: dashboard
            path: clients/microfrontends/dashboard
            port: 5003
          - name: courses
            path: clients/microfrontends/courses
            port: 5004
    
    steps:
      - name: Checkout source code
        uses: actions/checkout@v4
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: ${{ matrix.service.path }}/package-lock.json
      
      - name: Install dependencies
        working-directory: ${{ matrix.service.path }}
        run: npm ci
      
      - name: Run ESLint
        working-directory: ${{ matrix.service.path }}
        run: npm run lint
        continue-on-error: true
      
      - name: Build production bundle
        working-directory: ${{ matrix.service.path }}
        run: npm run build
      
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-${{ matrix.service.name }}
          path: ${{ matrix.service.path }}/dist/
          retention-days: 30
      
      - name: Display build summary
        run: |
          echo "## âœ… ${{ matrix.service.name }} Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Port: ${{ matrix.service.port }}" >> $GITHUB_STEP_SUMMARY
          echo "- Build Status: Success âœ…" >> $GITHUB_STEP_SUMMARY
          echo "- Artifact: build-${{ matrix.service.name }}" >> $GITHUB_STEP_SUMMARY

  # ==========================================
  # Stage 2: Build Docker Images
  # ==========================================
  build-docker-images:
    name: Build Docker Image - ${{ matrix.service.name }}
    runs-on: ubuntu-latest
    needs: build-and-test
    
    strategy:
      fail-fast: false
      matrix:
        service:
          - name: shell
            path: clients/microfrontends/shell
            image: smart-academy-shell
          - name: auth
            path: clients/microfrontends/auth
            image: smart-academy-auth
          - name: dashboard
            path: clients/microfrontends/dashboard
            image: smart-academy-dashboard
          - name: courses
            path: clients/microfrontends/courses
            image: smart-academy-courses
    
    steps:
      - name: Checkout source code
        uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Build Docker Image
        uses: docker/build-push-action@v5
        with:
          context: ${{ matrix.service.path }}
          file: ${{ matrix.service.path }}/Dockerfile.prod
          push: false
          tags: |
            ${{ secrets.DOCKERHUB_USERNAME }}/${{ matrix.service.image }}:latest
            ${{ secrets.DOCKERHUB_USERNAME }}/${{ matrix.service.image }}:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          load: true
      
      - name: Save Docker Image as artifact
        run: |
          docker save ${{ secrets.DOCKERHUB_USERNAME }}/${{ matrix.service.image }}:latest \
            -o ${{ matrix.service.name }}.tar
      
      - name: Upload Docker image artifact
        uses: actions/upload-artifact@v4
        with:
          name: docker-image-${{ matrix.service.name }}
          path: ${{ matrix.service.name }}.tar
          retention-days: 1

  # ==========================================
  # Stage 3: Container Security - Trivy Scan
  # ==========================================
  trivy-scan:
    name: Trivy Scan - ${{ matrix.service.name }}
    runs-on: ubuntu-latest
    needs: build-docker-images
    permissions:
      contents: read
      security-events: write
      actions: read
    
    strategy:
      fail-fast: false
      matrix:
        service:
          - name: shell
            image: smart-academy-shell
          - name: auth
            image: smart-academy-auth
          - name: dashboard
            image: smart-academy-dashboard
          - name: courses
            image: smart-academy-courses
    
    steps:
      - name: Checkout source code
        uses: actions/checkout@v4
      
      - name: Download Docker image
        uses: actions/download-artifact@v4
        with:
          name: docker-image-${{ matrix.service.name }}
      
      - name: Load Docker image
        run: docker load -i ${{ matrix.service.name }}.tar
      
      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ secrets.DOCKERHUB_USERNAME }}/${{ matrix.service.image }}:latest
          format: 'sarif'
          output: 'trivy-results-${{ matrix.service.name }}.sarif'
          severity: 'CRITICAL,HIGH'
          exit-code: '0'
      
      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        continue-on-error: true
        if: always()
        with:
          sarif_file: 'trivy-results-${{ matrix.service.name }}.sarif'
      
      - name: Generate Trivy HTML Report
        uses: aquasecurity/trivy-action@master
        if: always()
        with:
          image-ref: ${{ secrets.DOCKERHUB_USERNAME }}/${{ matrix.service.image }}:latest
          format: 'table'
          output: 'trivy-report-${{ matrix.service.name }}.txt'
          severity: 'CRITICAL,HIGH,MEDIUM,LOW'
      
      - name: Upload Trivy report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: trivy-report-${{ matrix.service.name }}
          path: trivy-report-${{ matrix.service.name }}.txt
          retention-days: 30

  # ==========================================
  # Stage 4: Publish to Docker Hub
  # ==========================================
  publish-to-dockerhub:
    name: Publish ${{ matrix.service.name }} to Docker Hub
    runs-on: ubuntu-latest
    needs: trivy-scan
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    
    strategy:
      fail-fast: false
      matrix:
        service:
          - name: shell
            image: smart-academy-shell
          - name: auth
            image: smart-academy-auth
          - name: dashboard
            image: smart-academy-dashboard
          - name: courses
            image: smart-academy-courses
    
    steps:
      - name: Checkout source code
        uses: actions/checkout@v4
      
      - name: Download Docker image
        uses: actions/download-artifact@v4
        with:
          name: docker-image-${{ matrix.service.name }}
      
      - name: Load Docker image
        run: docker load -i ${{ matrix.service.name }}.tar
      
      - name: Tag image with commit SHA
        run: |
          docker tag \
            ${{ secrets.DOCKERHUB_USERNAME }}/${{ matrix.service.image }}:latest \
            ${{ secrets.DOCKERHUB_USERNAME }}/${{ matrix.service.image }}:${{ github.sha }}
      
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      
      - name: Push to Docker Hub - Latest
        run: docker push ${{ secrets.DOCKERHUB_USERNAME }}/${{ matrix.service.image }}:latest
      
      - name: Push to Docker Hub - Commit SHA
        run: docker push ${{ secrets.DOCKERHUB_USERNAME }}/${{ matrix.service.image }}:${{ github.sha }}
      
      - name: Logout from Docker Hub
        if: always()
        run: docker logout
      
      - name: Display publish summary
        run: |
          echo "## ðŸš€ Published ${{ matrix.service.name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Image: ${{ secrets.DOCKERHUB_USERNAME }}/${{ matrix.service.image }}" >> $GITHUB_STEP_SUMMARY
          echo "- Tags: latest, ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY

  # ==========================================
  # Pipeline Summary
  # ==========================================
  pipeline-summary:
    name: Microfrontends Pipeline Summary
    runs-on: ubuntu-latest
    needs: [build-and-test, build-docker-images, trivy-scan, publish-to-dockerhub]
    if: always()
    
    steps:
      - name: Pipeline Status Summary
        run: |
          echo "## ðŸŽ¨ Microfrontends CI/CD Summary"
          echo ""
          echo "âœ… Build & Test: ${{ needs.build-and-test.result }}"
          echo "âœ… Docker Images: ${{ needs.build-docker-images.result }}"
          echo "âœ… Security Scan: ${{ needs.trivy-scan.result }}"
          echo "âœ… Docker Hub Publish: ${{ needs.publish-to-dockerhub.result }}"
          echo ""
          echo "### ðŸ“¦ Microfrontends Built:"
          echo "- Shell (Host) - Port 5001"
          echo "- Auth - Port 5002"
          echo "- Dashboard - Port 5003"
          echo "- Courses - Port 5004"
          echo ""
          echo "Workflow: ${{ github.workflow }}"
          echo "Run Number: ${{ github.run_number }}"
          echo "Commit SHA: ${{ github.sha }}"
